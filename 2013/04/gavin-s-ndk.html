<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>新篇章——NDK</title>
  
    <meta name="author" content="Gao Xu">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Gavin Droider</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>新篇章——NDK </h1>
</div>

<div class="row">
  <div class="span8">
    <p><a href="http://developer.android.com/tools/sdk/ndk/index.html">NDK</a>是从Android 1.5开始支持的，它是一系列工具的集合。它集成了交叉编译器，开发者只需要创建一个mk文件即可生成.so文件，而不用考虑如CPU、ABI、platform等。总而言之，NDK简化了JNI开发的过程。<br />
开发环境：Windows64+eclipse4.2+ADT21+CDT+NDKr8e+Cygwin<br />
首先，NDK使用起来还是挺方便的。首先，Java类中定义public native方法：
<pre><code>public native String stringFromJNI</code></pre>
在使用这个本地方法之前，还需要加载库：
<pre><code>static {
    System.loadLibrary(&ldquo;hellojni&rdquo;)
}</code></pre>
这样，Java部分就已经定义好了。<br />
要开始着手写c部分，首先要了解c中函数与Java方法的对应关系。例如上面的stringFromJNI方法，它在org.gaoxu.example.ndkdemo包下的MainActivity类，它对应的c函数名就应该为：
<pre><code>Java_org_gaoxu_example_ndkdemo_MainActivity_stringFromJNI(JNIEnv* env, jobject thiz)</code></pre>
这个函数的第二个参数先不管，第一个参数为JNIEnv指针类型，它指向了一个可执行的函数表，即可以使用它调用某个函数。实现这个方法的代码（这个文件放在工程根目录的jni目录下，记得必须声明jni.h头文件）：
<pre><code>#include <string.h>
#include <jni.h></p>

<p>jstring Java_org_gaoxu_example_ndkdemo_MainActivity_stringFromJNI(JNIEnv* env, jobject thiz) {
    return (*env)-&gt;NewStringUTF(env, &ldquo;Hello Gavin!&rdquo;);
}</code></pre>
文件名为hellojni.c。<br />
现在，还需要写一个Makefile，命名为Android.mk:
<pre><code>LOCAL_PATH := $(call my-dir)</p>

<p>include $(CLEAR_VARS)</p>

<p>LOCAL_MODULE    := hellojni
LOCAL_SRC_FILES := hellojni.c</p>

<p>include $(BUILD_SHARED_LIBRARY)</code></pre>
Android.mk必须在文件的开头定义LOCAL_PATH变量，它被用来定位源文件。在这里我们使用“my-dir”，也就是当前文件夹（包含Android.mk文件的文件夹）。<br />
第二句中，CLEAR_VARS变量会清除一些LOCAL开头的变量，比如LOCAL_MODULE、LOCAL_SRC_FILES等。<br />
第三句定义了编译完成后库的名称，这个名称必须是独一无二的，编译系统会自动添加前缀和后缀。在这，LOCAL_MODULE的值为hellojni，生成的文件名就是libhellojni.so。<br />
第四句定义了需要编译的源文件，很简单。<br />
第五句，声明需要编译为共享库。<br />
以上做完，打开Cygwin，进入工程目录，执行
<pre><code>$NDK_ROOT/ndk-build</code></pre>
如果以上步骤没有发生意外，即可完成编译。<br />
好了，其实整个过程的第二步，即定义c源文件那一步，方法名可以通过javah命令自动生成，这样也能省不少时间。写完java源文件后，eclipse会自动编译工程，并将class文件放入bin/classes文件夹下。执行
<pre><code>javah -classpath bin/classes -d jni org.gaoxu.example.ndkdemo.MainActivity</code></pre>
如果报错，可能是引导类的问题，可以加上-bootclasspath参数：
<pre><code>javah -classpath bin/classes -bootclasspath D:\android\android-sdk-windows\platforms\android-10\android.jar -d jni org.gaoxu.example.ndkdemo.MainActivity</code></pre>
还有个更简单的办法：
<pre><code>cd src
javah -d jni org.gaoxu.example.ndkdemo.MainActivity</code></pre></p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
          
            <li class="prev disabled"><a>&larr; Previous</a></li>
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/2013/04/revel-concepts.html" title="Revel框架——基本概念">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2013-05-12</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Android-ref">Android <span>11</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#ndk-ref">ndk <span>1</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Gao Xu 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-123-12'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
